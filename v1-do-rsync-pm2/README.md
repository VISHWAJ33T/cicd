# ðŸš€ Deployment Pipeline (Rsync + PM2 Cluster)

This project uses a "Push-to-Deploy" workflow via GitHub Actions.
**Strategy:** Local Build â†’ Rsync Upload â†’ PM2 Zero-Downtime Reload.

## ðŸ›¡ï¸ Security & Architecture
We prioritize security by minimizing the server's surface area and strictly controlling access.

### 1. SSH Hardening
- **No Root Login:** The deployment uses a restricted user (`deploy`) with limited permissions.
- **Key-Based Auth Only:** Password authentication is disabled for SSH; only the specific SSH key stored in GitHub Secrets can access the server.
- **Strict Host Checking:** The pipeline verifies the server's host key to prevent Man-in-the-Middle (MITM) attacks.

### 2. Artifact Security (Why Rsync?)
- **Minimal Footprint:** Unlike Git-based deployments, **source code is NOT uploaded** to the production server. Only the compiled `.next/standalone` folder and static assets are transferred.
- **Secrets Isolation:** `.env` files are not stored in the repo. Production secrets are injected during the build or managed via a secure `.env` file on the server.

### 3. Performance (Zero Downtime)
- **PM2 Cluster Mode:** The app runs in `exec_mode: "cluster"`, utilizing all available CPU cores for maximum throughput.
- **Atomic Reloads:** `pm2 reload` spins up new instances and waits for them to be ready before killing the old ones, ensuring 0% dropped connections during deployment.

---

## ðŸ› ï¸ Setup Instructions

### 1. Prerequisites
- A DigitalOcean Droplet (Ubuntu 22.04+)
- A domain name pointing to the Droplet IP.

### 2. One-Click Server Provisioning
1. SSH into your server as root: `ssh root@your_ip`
2. Create the setup script: `nano setup_vps.sh`
3. Paste the content of `setup_vps.sh` (Version 1).
4. Run it: `bash setup_vps.sh`
5. **Critical:** Copy the `SSH_PRIVATE_KEY` printed at the end.

### 3. GitHub Secrets
Go to **Settings > Secrets and variables > Actions** and add:

| Secret Name | Value |
|-------------|-------|
| `DROPLET_IP` | Your server's IP address |
| `DROPLET_USER` | The username you chose (e.g., `deploy`) |
| `SSH_PRIVATE_KEY` | The private key generated by the script |
| `NEXT_PUBLIC_API_URL` | Your production API URL |

### 4. Deploying
Simply push to `main`. The pipeline will:
1. Build the app on GitHub's fast servers.
2. Securely Rsync the artifacts to `/home/deploy/app/`.
3. Reload PM2 without downtime.
