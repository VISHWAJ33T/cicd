# ðŸ° Monorepo Deployment Pipeline (Version 1: Rsync + PM2)

This deployment strategy is designed for **monorepos** containing multiple Next.js applications (e.g., `apps/web`, `apps/admin`, `packages/ui`).

**Strategy:** Local Build â†’ Filtered Build â†’ Rsync Upload â†’ PM2 Zero-Downtime Reload.

## ðŸŽ¯ Why Monorepo-Specific?

1. **Path-Based Filtering:** Only deploys the app that changed (e.g., `apps/web/**` triggers web deployment, not admin)
2. **Multiple Apps on One Server:** Each app gets its own directory (`/home/deploy/apps/web`, `/home/deploy/apps/admin`)
3. **Independent Ports:** Each app runs on a different port (3000, 3001, etc.) with separate Nginx configs
4. **Isolated PM2 Processes:** Each app has its own PM2 process with unique names

## ðŸ“‹ Prerequisites

### Next.js Configuration

Your Next.js apps **must** be configured for standalone output:

**File:** `apps/web/next.config.js` (or `apps/web/next.config.mjs`)

```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  output: 'standalone', // REQUIRED for this deployment strategy
  // ... other config
};

module.exports = nextConfig;
```

### Package.json Scripts

Each app in your monorepo needs a build script:

**File:** `package.json` (root or workspace)

```json
{
  "scripts": {
    "build": "next build",
    "start": "next start"
  },
  "workspaces": [
    "apps/*",
    "packages/*"
  ]
}
```

**File:** `apps/web/package.json`

```json
{
  "name": "web",
  "scripts": {
    "build": "next build"
  }
}
```

## ðŸ› ï¸ Setup Instructions

### 1. Server Setup (Run Once Per Server)

1. SSH into your server as root: `ssh root@your_ip`
2. Copy the setup script: `nano setup_monorepo.sh`
3. Paste the content of `setup_monorepo.sh`
4. Run it: `bash setup_monorepo.sh`
5. When prompted:
   - Enter deploy username (e.g., `deploy`)
   - Enter Node.js version (default: 20)
   - **First app setup:** Enter app name (e.g., `web`), domain, and port
6. **Critical:** Copy the `SSH_PRIVATE_KEY` printed at the end

### 2. Setup Additional Apps

Run `setup_monorepo.sh` again for each app:
- App name: `admin`
- Domain: `admin.example.com`
- Port: `3001` (different from web)

The script is idempotent - it won't recreate the user or Node.js if they already exist.

### 3. GitHub Secrets

Go to **Settings > Secrets and variables > Actions** and add:

| Secret Name | Value |
|-------------|-------|
| `DROPLET_IP` | Your server's IP address |
| `DROPLET_USER` | The username you chose (e.g., `deploy`) |
| `SSH_PRIVATE_KEY` | The private key generated by the script |
| `NEXT_PUBLIC_API_URL` | Your production API URL |

### 4. App-Specific Configuration

#### Ecosystem Config

Each app needs its own `ecosystem.config.js` file:

**File:** `apps/web/ecosystem.config.js`

```javascript
module.exports = {
    apps: [{
        name: "web-app", // UNIQUE - must be different for each app
        script: "server.js",
        instances: "max",
        exec_mode: "cluster",
        env: {
            NODE_ENV: "production",
            PORT: 3000, // UNIQUE - must match Nginx config
        }
    }]
};
```

**File:** `apps/admin/ecosystem.config.js`

```javascript
module.exports = {
    apps: [{
        name: "admin-app", // UNIQUE - different from web-app
        script: "server.js",
        instances: "1",
        exec_mode: "fork",
        env: {
            NODE_ENV: "production",
            PORT: 3001, // UNIQUE - different from web
        }
    }]
};
```

#### Workflow Files

Create separate workflow files for each app:

- `.github/workflows/deploy-web.yml` - Deploys `apps/web`
- `.github/workflows/deploy-admin.yml` - Deploys `apps/admin`

Each workflow only triggers when its specific app changes.

### 5. Deploying

Simply push to `main`. The pipeline will:
1. Detect which app changed (via path filters)
2. Build only that app
3. Securely Rsync artifacts to `/home/deploy/apps/{app-name}/`
4. Reload PM2 without downtime

## ðŸ“‚ Server Structure

```
/home/deploy/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ web/              <-- Web app deployment
â”‚   â”‚   â”œâ”€â”€ server.js
â”‚   â”‚   â”œâ”€â”€ .next/
â”‚   â”‚   â””â”€â”€ ecosystem.config.js
â”‚   â””â”€â”€ admin/            <-- Admin app deployment
â”‚       â”œâ”€â”€ server.js
â”‚       â”œâ”€â”€ .next/
â”‚       â””â”€â”€ ecosystem.config.js
â””â”€â”€ .ssh/
    â””â”€â”€ github_action_key
```

## ðŸ”’ Security & Architecture

- **SSH Hardening:** Key-based auth only, restricted deploy user
- **Minimal Footprint:** Only compiled artifacts, no source code
- **Zero Downtime:** PM2 cluster mode with atomic reloads
- **Isolated Apps:** Each app runs independently with its own port and PM2 process

## ðŸš¨ Troubleshooting

### Build Fails: "output: 'standalone' not found"

**Solution:** Ensure `next.config.js` has `output: 'standalone'`

### Port Already in Use

**Solution:** Each app must use a unique port. Check `ecosystem.config.js` and Nginx configs.

### PM2 Process Name Conflict

**Solution:** Ensure each `ecosystem.config.js` has a unique `name` field.

### Wrong App Deploys

**Solution:** Check workflow `paths` filters match your app directory structure.

